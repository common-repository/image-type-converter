!function(e){"use strict";var s=window.gpls_wicor_image_converter_localize_vars;e(document).on("ready",e=>{new a});class a{constructor(){this.cpts=[],this.sizes=[],this.sizeAction="",this.selectedImagesDirect=[],this.selectedImagesCPTs=[],this.foundImages={},this.foundImagesPages=1,this.selectedImages=[],this.events()}insertSelectedDirectImages(a){var t=e("."+s.classes_prefix+"-selected-images-direct");a.forEach(e=>{var a=t.find(".img-item-clone").clone().removeClass("img-item-clone d-none").addClass("img-item"),i=e.editLink;(i=new URL(i)).searchParams.set(s.classes_prefix+"-force-img-refresh",(Math.random()+1).toString(36).substring(7)),a.find(".frame-remove").attr("data-id",e.id),a.find("a").attr("href",i.href),a.find("img").attr("src",e.sizes.thumbnail?e.sizes.thumbnail.url:e.url),t.append(a)})}events(){e(".main-loader").hide(),e(".main-loader .fetching-data").addClass("d-none"),e('[data-toggle="tooltip"]').tooltip(),e(document).on("click",".close-modal-btn",s=>{s.preventDefault(),e(s.target).closest(".bulk-apply-modal").modal("hide")}),e(".apply-watermarks-template-selection-direct").on("click",a=>{a.preventDefault(),e(a.target).data("context");var t,i={title:s.labels.select_images,library:{orderby:"date",query:!0,post_mime_type:["image/png","image/jpg","image/jpeg","image/webp","image/avif","image/gif"],"gpls-wicor-image-converter-context-modal":"create-watermark-template"},button:{text:s.labels.select_images},multiple:!0};(t=wp.media(i)).open(),t.on("select",e=>{var s=t.state().get("selection").toJSON();s.forEach(e=>{this.selectedImagesDirect.push(e.id)}),this.selectedImages=this.selectedImagesDirect,this.insertSelectedDirectImages(s),this.toggleSteps()})}),e(document).on("click","."+s.classes_prefix+"-selected-images-direct .frame-remove",s=>{var a=e(s.target);a.hasClass(".frame-remove")||(a=a.parents(".frame-remove"));var t=a.data("id"),i=this.selectedImagesDirect.indexOf(parseInt(t));i>-1&&(this.selectedImagesDirect.splice(i,1),a.parents(".img-item").remove(),this.selectedImages=this.selectedImagesDirect)}),e(".select-images-by-option").on("change",s=>{var a=e(s.target).val();e("#select-images-by-"+a).collapse("show").siblings(".select-images-by-option-content").collapse("hide"),"cpt"===a?this.selectedImages=this.selectedImagesCPTs:"direct"===a&&(this.selectedImages=this.selectedImagesDirect),"full"===a&&e(".step-2").collapse("show"),this.toggleSteps()}),e("#select-images-by-cpt").on("change",".cpt-name-checkbox",s=>{e(s.targe);e(".cpt-name-checkbox:checked").length?e(".search-for-images").collapse("show"):e(".search-for-images").collapse("hide"),this.toggleSteps()}),e(".bulk-select-sizes").on("click",s=>{var a=e(s.target),t=a.parents(".step-2");!0==a.prop("checked")?t.find(".size-item").prop("checked",!0):t.find(".size-item").prop("checked",!1),e(".step-3").collapse("show")}),e(".size-item").on("change",s=>{e(".step-4").collapse("show")}),e(".search-for-images-in-posts").on("click",async s=>{s.preventDefault();let a=(await this.findImagesByPosts(1,!0)).data.result.attachments_count;e(".found-images-count").show(),e(".found-images-count").find(".images-count").text(a),a?e(".select-specific-images").show():e(".select-specific-images").hide()}),e(".select-specific-images").on("click",s=>{if(s.preventDefault(),e(".selected-images-watermarks-template-modal").modal("show"),this.foundImages[1]){var a=e(".selected-images-watermarks-template-modal .actions");this.updateListFoundImages(this.foundImages[1],a,1,this.foundImagesPages,!0)}else this.findImagesByPosts()}),e(".selected-images-watermarks-template-modal .next-page").on("click",s=>{var a=e(s.target);a.hasClass("button")||(a=a.parent());var t=e(".selected-images-watermarks-template-modal .actions"),i=parseInt(t.find(".total-pages").data("pages")),d=parseInt(t.find(".current-page").text())+1;this.foundImages[d]?this.updateListFoundImages(this.foundImages[d],t,d,i,!0):this.findImagesByPosts(d)}),e(".selected-images-watermarks-template-modal .prev-page").on("click",s=>{var a=e(s.target);a.hasClass("button")||(a=a.parent());var t=e(".selected-images-watermarks-template-modal .all-found-images-pagination"),i=parseInt(t.find(".total-pages").data("pages")),d=parseInt(t.find(".current-page").text())-1;t.find(".current-page").val(d),this.foundImages[d]?this.updateListFoundImages(this.foundImages[d],t,d,i,!0):this.findImagesByPosts(d)}),e(".selected-images-watermarks-template-modal .first-page").on("click",s=>{var a=e(s.target);a.hasClass("button")||(a=a.parent());var t=e(".selected-images-watermarks-template-modal .all-found-images-pagination"),i=parseInt(t.find(".total-pages").data("pages"));t.find(".current-page").val(1),this.foundImages[1]?this.updateListFoundImages(this.foundImages[1],t,1,i,!0):this.findImagesByPosts(1)}),e(".selected-images-watermarks-template-modal .last-page").on("click",s=>{var a=e(s.target);a.hasClass("button")||(a=a.parent());var t=e(".selected-images-watermarks-template-modal .all-found-images-pagination"),i=parseInt(t.find(".total-pages").data("pages")),d=parseInt(a.data("paged"));t.find(".current-page").val(d),this.foundImages[d]?this.updateListFoundImages(this.foundImages[d],t,d,i,!0):this.findImagesByPosts(d)}),e(document).on("change",".cpt-name-checkbox",e=>{this.foundImages={}}),e(".apply-subsize-actions-submit-btn").on("click",e=>{e.preventDefault(),this.applyConvert()}),e(document).on("change",".cb-select-all-1",s=>{var a=e(s.target),t=a.parents(".wp-list-table"),i=a.is(":checked");e.each(t.find(".cb-select-all"),(s,a)=>{e(a).prop("checked",i).trigger("change")})}),e(document).on("change","#modal-found-images-watermarks-template .cb-select-all",s=>{var a=e(s.target);this.updateSelectedImages(a)})}applyConvert(a=0){this.toggleLoader("","show",!0);var t=Math.ceil(this.selectedImages.length/parseInt(s.offsetLength));0==a&&(e(".main-loader .loader-progress").val(0),e(".main-loader .loader-progress-num").removeClass("d-none").text("0%"));let i=e(".select-images-by-option:checked").val(),d=e(".size-item:checked").val(),l=e(".keep-ext").is(":checked");"full"===i&&(t=Math.ceil(parseInt(e("#select-images-by-full").data("count"))/parseInt(s.offsetLength)));var o={action:s.bulkTypeConvertAction,nonce:s.nonce,images:this.selectedImages,step:a,totalSteps:t,selectType:i,type:d,keepExt:l};e.ajax({method:"POST",url:s.ajaxUrl,data:o,success:s=>{if(s?.data&&s?.data?.message&&s.data.message.length&&this.showToast(s?.data?.message,"bg-"+s.data.status),!1===s.success&&this.toggleLoader("","hide"),s.data.status&&s.success){if("end"===s.data.step)e(".main-loader .loader-progress").val(100),e(".main-loader .loader-progress-num").text("100%"),setTimeout(()=>{this.toggleLoader("","hide")},2e3);else{var a=Math.round(100*parseFloat(parseInt(s.data.step)/t));e(".main-loader .loader-progress").val(a),e(".main-loader .loader-progress-num").text(a+"%"),this.applyConvert(s.data.step)}}},error:e=>{console.log("error:",e),e?.data?.message&&this.showToast(e.data.message,"bg-danger")}})}updateListFoundImages(s,a,t,i,d=!1){var l=e(".selected-images-watermarks-template-modal");l.find(".wp-list-table").find("tbody").html(s),d&&e.each(l.find(".cb-select-all"),(s,a)=>{var t=e(a),i=parseInt(t.data("id"));this.selectedImages.includes(i)?t.prop("checked",!0):t.prop("checked",!1)}),s.length?e(".step-3").collapse("show"):e(".step-3").collapse("hide"),this.setupPagination(a,t,i)}setupPagination(e,s,a){e.find(".first-page").data("paged",1),e.find(".current-page").text(s),e.find(".total-pages").data("pages",a).text(a),e.find(".next-page").data("paged",s+1),e.find(".last-page").data("paged",a),e.find(".next-page").removeClass("disabled"),e.find(".last-page").removeClass("disabled"),e.find(".prev-page").removeClass("disabled"),e.find(".first-page").removeClass("disabled"),s<=1&&(e.find(".prev-page").addClass("disabled"),e.find(".first-page").addClass("disabled"),a<=1&&(e.find(".next-page").addClass("disabled"),e.find(".last-page").addClass("disabled"))),s>=a&&(e.find(".next-page").addClass("disabled"),e.find(".last-page").addClass("disabled"),a<=1&&(e.find(".prev-page").addClass("disabled"),e.find(".first-page").addClass("disabled")))}async findImagesByPosts(a=1,t=!1){var i=[];e(".cpt-name-checkbox:checked").each((s,a)=>{i.push(e(a).val())});var d={paged:a,action:s.findImagesInPostsAction,nonce:s.nonce,cpt_name:i};return e(".step-4").collapse("hide"),this.toggleLoader(t?"":"found-images","show"),new Promise((i,l)=>{e.ajax({method:"POST",url:s.ajaxUrl,data:d,success:s=>{if(!s.success&&s?.data?.message&&(this.showToast(s.data.message,"bg-"+s.data.status),e("#modal-found-images-watermarks-template").modal("hide"),this.toggleLoader(t?"":"found-images","hide"),i(s)),s?.data?.result){var d=s.data.result,l=e("#modal-found-images-watermarks-template"),o=d.attachments_count,n=l.find(".actions"),r=Math.ceil(o/20);n.find(".displaying-num").text(o+" items"),this.updateListFoundImages(d.html,n,a,r,!1);var c=Object.values(d.attachments_ids).map(e=>parseInt(e));1===a&&(this.selectedImagesCPTs=c,this.selectedImages=c,this.foundImagesPages=r),this.foundImages[a]=d.html,this.toggleSteps()}this.toggleLoader(t?"":"found-images","hide"),i(s)},error:s=>{e(".select-errors-dialog").html(s.responseText).dialog("open"),this.toggleLoader(t?"":"found-images","hide"),l(s)}})})}updateSelectedImages(e){var s=parseInt(e.data("id"));if(e.is(":checked"))this.selectedImagesCPTs.includes(s)||(this.selectedImagesCPTs.push(s),this.selectedImages=this.selectedImagesCPTs);else{var a=this.selectedImagesCPTs.indexOf(s);a>-1&&(this.selectedImagesCPTs.splice(a,1),this.selectedImages=this.selectedImagesCPTs)}this.toggleSteps()}showToast(a,t="bg-primary",i=!1){var d=e("."+s.classes_prefix+"-msgs-toast");d.removeClass((e,s)=>(s.match(/(^|\s)bg-\S+/g)||[]).join(" "));var l="";i?(l='<ul class="toast-notice-list">',toastHTML.forEach(e=>{l+='<li class="notice-item"><p>'+e+"</p></li>"}),l+="</ul>"):l="<p>"+a+"</p>",d.addClass(t).find(".toast-body").html(l),d.toast("show")}loading(e,s=!0){s?(e.addClass("disabled").prop("disabled",!0),e.siblings(".spinner").addClass("is-active")):(e.removeClass("disabled").prop("disabled",!1),e.siblings(".spinner").removeClass("is-active disabled"))}toggleLoader(s="",a,t=!1){if(""==s)var i=e(".main-loader");else if("found-images"==s)var i=e(".selected-images-watermarks-template-modal").find(".loader");else var i=e("#all-posts-"+s).find(".loader");"show"==a?i.show():"hide"==a&&i.hide(),t?(i.find(".loader-progress").removeClass("d-none"),i.find(".loader-progress-num").removeClass("d-none")):(i.find(".loader-progress").addClass("d-none"),i.find(".loader-progress-num").addClass("d-none"))}toggleSteps(s=!1){this.selectedImages.length?e(".step-2").collapse("show"):e(".step-2").collapse("hide"),e(".size-item:checked").length&&this.selectedImages.length?e(".step-4").collapse("show"):e(".step-4").collapse("hide"),e(".size-item:checked").length&&e("#select-images-full").is(":checked")&&e(".step-4").collapse("show")}}}(jQuery);
